@using AutomationToolbox.Core.Models
@using AutomationToolbox.Core.Utils
@using System.Globalization
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer

<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>@Localizer["Converter"]</span>
        <button class="btn btn-sm btn-outline-danger" @onclick="OnRemove" title="@Localizer["RemoveConverter"]">
            <i class="fa-solid fa-trash"></i>
        </button>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">@Localizer["InputNumber"]</label>
                <input type="text" class="form-control @(string.IsNullOrEmpty(errorMessage) ? "" : "is-invalid")" @bind="inputValue" @bind:event="oninput" placeholder="..." />
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="invalid-feedback">
                        @errorMessage
                    </div>
                }
            </div>
            <div class="col-md-6">
                <label class="form-label">@Localizer["Base"]</label>
                <select class="form-select" @bind="parametersBase">
                    <option value="@ConversionFormat.Binary">@Localizer["Binary"] (2)</option>
                    <option value="@ConversionFormat.Octal">@Localizer["Octal"] (8)</option>
                    <option value="@ConversionFormat.Decimal">@Localizer["Decimal"] (10)</option>
                    <option value="@ConversionFormat.Hexadecimal">@Localizer["Hexadecimal"] (16)</option>
                    <option value="@ConversionFormat.IEEE754">@Localizer["IEEE754"]</option>
                </select>
            </div>
        </div>

        <hr />

        <div class="row g-3">
            <div class="col-md-12">
                <div class="input-group mb-2">
                    <span class="input-group-text" style="width: 100px;">@Localizer["Binary"]</span>
                    <input type="text" class="form-control" value="@Convert(ConversionFormat.Binary)" readonly />
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text" style="width: 100px;">@Localizer["Octal"]</span>
                    <input type="text" class="form-control" value="@Convert(ConversionFormat.Octal)" readonly />
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text" style="width: 100px;">@Localizer["Decimal"]</span>
                    <input type="text" class="form-control" value="@Convert(ConversionFormat.Decimal)" readonly />
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text" style="width: 100px;">@Localizer["Hex"]</span>
                    <input type="text" class="form-control" value="@Convert(ConversionFormat.Hexadecimal)" readonly />
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text" style="width: 100px;">@Localizer["IEEE754"]</span>
                    <input type="text" class="form-control" value="@Convert(ConversionFormat.IEEE754)" readonly />
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnRemove { get; set; }

    private string _inputValue = "";
    private string inputValue 
    {
        get => _inputValue;
        set
        {
            _inputValue = value.ToUpperInvariant();
            ValidateInput();
        }
    }

    private ConversionFormat _parametersBase = ConversionFormat.Decimal;
    private ConversionFormat parametersBase
    {
        get => _parametersBase;
        set
        {
            _parametersBase = value;
            ValidateInput();
        }
    }

    private string errorMessage = "";

    private void ValidateInput()
    {
        if (string.IsNullOrEmpty(_inputValue))
        {
            errorMessage = "";
            return;
        }

        string decimalSeparator = CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator;
        
        string allowedChars = _parametersBase switch
        {
            ConversionFormat.Binary => "01",
            ConversionFormat.Octal => "01234567",
            ConversionFormat.Decimal => "0123456789",
            ConversionFormat.Hexadecimal => "0123456789ABCDEF",
            ConversionFormat.IEEE754 => "0123456789-E" + decimalSeparator, // IEEE 754 (Decimal Float chars + localized separator)
            _ => ""
        };

        // Note: _inputValue is already uppercased in the setter
        bool isValid = _inputValue.All(c => allowedChars.Contains(c));

        if (!isValid)
        {
            errorMessage = string.Format(Localizer["InvalidInput"], _parametersBase);
        }
        else
        {
            errorMessage = "";
        }
    }

    private string Convert(ConversionFormat targetBase)
    {
        if (!string.IsNullOrEmpty(errorMessage) || string.IsNullOrEmpty(inputValue))
        {
            return "";
        }

        if (targetBase == parametersBase)
        {
            return inputValue; // No conversion needed
        }
        
        try
        {
            return NumberConverter.Convert(inputValue, parametersBase, targetBase) ?? "";
        }
        catch (OverflowException)
        {
            return Localizer["ValueOverflow"];
        }
    }
}
